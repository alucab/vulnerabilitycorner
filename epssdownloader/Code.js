//https://www.first.org/epss/data_stats
/*
If you would like historical data for EPSS, you can directly access daily files by entering the target date into the URL in this format: https://epss.cyentia.com/epss_scores-YYYY-mm-dd.csv.gz, where YYYY is the four digit year, mm is the two digit month and dd is a two digit day. For example, if you want to pull February 1st, 2023, you would retrieve https://epss.cyentia.com/epss_scores-2023-02-01.csv.gz.

If you do historical analysis, keep in mind the following dates:

No scores are available before 2021-04-14
EPSS v2 (v2022.01.01) started publishing on 2022-02-04, you will see a major shift in most scores on that day, and the files now include a comment at the start with # stating the model version and publish date.
EPSS v3 (v2023.03.01) started publishing on 2023-03-07, you will see a major shift in most scores on that day.
*/

const EPSS_URL = "https://epss.cyentia.com/epss_scores-current.csv.gz"

/* PREP PARENT FOLDER OBJECT */
/* (1) get the parent folder object */
const FOLDER =DriveApp.getFileById(ScriptApp.getScriptId()).getParents().next();
/* (2) print the parent_folder url for reference */
console.log('folder url:',FOLDER.getUrl());

const DATE = getSQLDate();
const NAME = "EPSS-"+DATE
const CSV_NAME = NAME +".csv"
const GZ_CSV_NAME = CSV_NAME +".gz"
const GSH_ID = "15Y8v39ViK5tm7XN56Vmi0gx9G1PVagLEf8MA6tRslck";

function saveFile(EPSSblob){
  if (!FOLDER.getFilesByName(EPSSblob.getName()).hasNext()){
    /* create the blob file in google drive and get its file handler object */ 
    epss_gzip_file=DriveApp.createFile(EPSSblob);
    /* print the file url for reference */
    console.log('csv_file url:',epss_gzip_file.getUrl())
    /* move the file to the parent folder */
    epss_gzip_file.moveTo(FOLDER);
  } else{
    console.log('error: csv_file already exist');
  }
}

function copySpreadsheetInSameFolder(spreadsheetId,copyName){
  if (!FOLDER.getFilesByName(copyName).hasNext()){
    DriveApp.getFileById(spreadsheetId).makeCopy(copyName, FOLDER); 
  } else{
    console.log('error: spreadsheetObj already exist:%s',copyName);
  }
}

function loadEPSS(){

  var b=fetchUrl(EPSS_URL);
  b.setName(GZ_CSV_NAME); 
  b.setContentTypeFromExtension();
  //saveFile(b)

  var ub = Utilities.ungzip(b);

  ub.setContentTypeFromExtension();

  var csv = ub.getDataAsString();
  
  var epssdata = Utilities.parseCsv(csv, ',');
  //removes the first comment
  epssdata.shift();
  epssdata[0][0]="CVE"
  epssdata[0][1]="EPSS"
  epssdata[0][2]="Percentile"

  

  copySpreadsheetInSameFolder(GSH_ID,NAME)

  Utilities.sleep(2000)

  epssSpreadSheet = SpreadsheetApp.openById(GSH_ID);
  epssSheet = epssSpreadSheet.getSheetByName("EPSS")
  epssSheet.clearContents();
  /* (3) paste the CSV content to the worksheet */
  epssSheet.getRange(1,1,epssdata.length,epssdata[0].length).setValues(epssdata);
  return
}

function fetchUrl(url) {
  let config = {
    muteHttpExceptions: false
  };
  let response = UrlFetchApp.fetch(url, config);
  let blob = response.getBlob();
  blob.setContentType('application/x-gzip')
  return blob;
}

function getSQLDate(){
  var today = new Date();
  var newEstimate = today.toISOString().slice(0, 10) //year +'-'+ month + '-' + date;
  //Logger.log(newEstimate);
  return newEstimate
}


